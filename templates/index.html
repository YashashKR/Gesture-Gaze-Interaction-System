<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimodal Air Canvas - AI Control System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='images/web-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <div class="status-indicator" id="statusIndicator">
        <span class="status-dot status-inactive" id="statusDot"></span>
        <span id="statusText">System Offline</span>
    </div>

    <div class="header">
        <h1>Gesture-Gaze Interaction System</h1>
        <p>Next-Generation Multimodal Control System</p>
    </div>

    <div style="text-align: center; margin: 1rem 0;">
        <div class="big-stop-button" onclick="showModal('stopModal')">
            <div style="display: flex; align-items: center; gap: 0.8rem;">
                <div style="flex: 1;">
                    <h2 style="color: black; margin: 0; font-family: 'Orbitron', monospace; font-size: 1.1rem;">STOP DETECTION</h2>
                    <p style="color: rgba(0,0,0,0.7); margin: 0; font-size: 0.7rem;">Stop all active modes</p>
                </div>
                <button class="big-stop-btn" onclick="event.stopPropagation(); stopAllModes()">
                    <i class="fas fa-stop"></i> STOP
                </button>
            </div>
        </div>
    </div>

    <div class="carousel-container">
        <button class="carousel-btn prev-btn" onclick="scrollCarousel(-1)">
            <i class="fas fa-chevron-left"></i>
        </button>

        <div class="carousel-track-container" id="modeTrack">
            <div class="carousel-track">
                <div class="control-card" onclick="showModal('handModal')">
                    <i class="fas fa-hand-paper card-icon" style="color: #fccdb4;"></i>
                    <h3 class="card-title">Hand Gesture Control</h3>
                    <p class="card-description">Advanced position-based scrolling with fist gestures for speed control</p>
                    <button class="start-btn" onclick="event.stopPropagation(); startMode('hand')">
                        <i class="fas fa-play"></i> Start Hand Mode
                    </button>
                </div>

                <div class="control-card" onclick="showModal('eyeModal')">
                    <i class="fas fa-eye card-icon" style="color: #1c54be;"></i>
                    <h3 class="card-title">Eye Tracking Control</h3>
                    <p class="card-description">Navigate using your eye movements with precision tracking</p>
                    <button class="start-btn" onclick="event.stopPropagation(); startMode('eye')">
                        <i class="fas fa-play"></i> Start Eye Mode
                    </button>
                </div>

                <div class="control-card" onclick="showModal('canvasModal')">
                    <i class="fas fa-paint-brush card-icon" style="color: #ff7700;"></i>
                    <h3 class="card-title">Air Canvas Drawing</h3>
                    <p class="card-description">Draw in the air using hand gestures and create digital art</p>
                    <button class="start-btn" onclick="event.stopPropagation(); startMode('canvas')">
                        <i class="fas fa-play"></i> Start Canvas Mode
                    </button>
                </div>

                <div class="control-card" onclick="showModal('gameModal')">
                    <i class="fas fa-gamepad card-icon" style="color: #f94545;"></i>
                    <h3 class="card-title">Snake Game</h3>
                    <p class="card-description">Play the classic Snake game using hand gestures - point to control direction!</p>
                    <button class="start-btn" onclick="event.stopPropagation(); startMode('game')">
                        <i class="fas fa-play"></i> Start Game Mode
                    </button>
                </div>
            </div>
        </div>

        <button class="carousel-btn next-btn" onclick="scrollCarousel(1)">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div id="handModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('handModal')">&times;</span>
            <h2>üñêÔ∏è Hand Gesture Control</h2>
            <p>Experience intuitive computer control using your hand movements!</p>
            <ul class="feature-list">
                <li>Move cursor with index finger</li>
                <li>Click by pinching thumb and index</li>
                <li>Hold hand up/down for scrolling</li>
                <li>Make fist for fast scrolling</li>
                <li>Position-based scroll control</li>
                <li>Real-time gesture recognition</li>
            </ul>
            <div class="action-buttons">
                <button class="btn-primary" onclick="startMode('hand'); closeModal('handModal')">
                    <i class="fas fa-rocket"></i> Launch Now
                </button>
                <button class="btn-secondary" onclick="closeModal('handModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="eyeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eyeModal')">&times;</span>
            <h2>üëÅÔ∏è Eye Tracking Control</h2>
            <p>Navigate your computer using just your eyes with advanced AI tracking!</p>
            <ul class="feature-list">
                <li>Cursor follows your gaze</li>
                <li>Blink to click</li>
                <li>Wink gestures for scrolling</li>
                <li>Voice command integration</li>
                <li>Accessibility-focused design</li>
            </ul>
            <div class="action-buttons">
                <button class="btn-primary" onclick="startMode('eye'); closeModal('eyeModal')">
                    <i class="fas fa-rocket"></i> Launch Now
                </button>
                <button class="btn-secondary" onclick="closeModal('eyeModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="canvasModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('canvasModal')">&times;</span>
            <h2>üé® Air Canvas Drawing</h2>
            <p>Create digital art by drawing in the air with your hands!</p>
            <ul class="feature-list">
                <li>Multiple brush colors</li>
                <li>Adjustable brush sizes</li>
                <li>Eraser functionality</li>
                <li>Clear canvas option</li>
                <li>Real-time drawing feedback</li>
            </ul>
            <div class="action-buttons">
                <button class="btn-primary" onclick="startMode('canvas'); closeModal('canvasModal')">
                    <i class="fas fa-rocket"></i> Launch Now
                </button>
                <button class="btn-secondary" onclick="closeModal('canvasModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="gameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('gameModal')">&times;</span>
            <h2>üêç Gesture-Controlled Snake Game</h2>
            <p>Experience the classic Snake game with a modern twist - control it with your hand gestures!</p>
            <ul class="feature-list">
                <li>Point UP with your index finger to move up</li>
                <li>Point DOWN to move down</li>
                <li>Point LEFT to move left</li>
                <li>Point RIGHT to move right</li>
                <li>Real-time gesture recognition</li>
                <li>Score tracking and game over detection</li>
                <li>Smooth gameplay with collision detection</li>
            </ul>
            <div class="game-instructions">
                <h4 style="color: white; margin: 1rem 0 0.5rem 0;">üéÆ How to Play:</h4>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; line-height: 1.4;">
                    Hold your hand up to the camera and point your index finger in the direction you want the snake to move. 
                    Eat the red food to grow longer and increase your score. Avoid hitting yourself!
                </p>
            </div>
            <div class="action-buttons">
                <button class="btn-primary" onclick="startMode('game'); closeModal('gameModal')">
                    <i class="fas fa-rocket"></i> Start Game
                </button>
                <button class="btn-secondary" onclick="closeModal('gameModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="stopModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stopModal')">&times;</span>
            <h2>‚èπÔ∏è Stop Detection</h2>
            <p>This will stop all active tracking modes and return the system to idle state.</p>
            <ul class="feature-list">
                <li>Stop hand gesture tracking</li>
                <li>Stop eye tracking mode</li>
                <li>Close drawing canvas</li>
                <li>Stop gesture-controlled game</li>
                <li>Release camera resources</li>
                <li>Return to main menu</li>
            </ul>
            <div class="action-buttons">
                <button class="btn-primary" onclick="stopAllModes(); closeModal('stopModal')" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                    <i class="fas fa-stop"></i> Stop All Modes
                </button>
                <button class="btn-secondary" onclick="closeModal('stopModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="chatbot-container">
        <button id="chatbot-toggle">üí¨</button>
        <div id="chatbox" class="hidden">
            <div id="chatbox-header">
                <span>AirCanvas Assistant ü§ñ</span>
                <button id="close-chat">‚úñ</button>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ask me something..." />
                <button id="send-btn">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function startMode(mode) {
            let modeIcon = '';
            let modeName = '';
            
            switch(mode) {
                case 'hand':
                    modeIcon = 'üñêÔ∏è';
                    modeName = 'Hand Gesture Control';
                    break;
                case 'eye':
                    modeIcon = 'üëÅÔ∏è';
                    modeName = 'Eye Tracking Control';
                    break;
                case 'canvas':
                    modeIcon = 'üé®';
                    modeName = 'Air Canvas Drawing';
                    break;
                case 'game':
                    modeIcon = 'üêç';
                    modeName = 'Gesture-Controlled Snake Game';
                    break;
            }
            
            showActivationPopup(modeIcon, modeName, 'activated');
            showStatus(`Starting ${mode} mode...`, 'active');
            
            fetch(`/start/${mode}`)
                .then(response => {
                    if (response.ok) {
                        showStatus(`${mode} mode active`, 'active');
                    } else {
                        showStatus('Error starting mode', 'inactive');
                        showNotification('‚ùå Failed to start mode', 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error', 'inactive');
                    showNotification('üîå Connection error', 'error');
                });
        }

        function stopAllModes() {
            showActivationPopup('‚èπÔ∏è', 'All Detection Modes', 'stopped');
            showStatus('Stopping all modes...', 'inactive');
            
            fetch('/stop')
                .then(response => {
                    if (response.ok) {
                        showStatus('All modes stopped', 'inactive');
                    } else {
                        showStatus('Error stopping modes', 'inactive');
                        showNotification('‚ùå Failed to stop modes', 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error', 'inactive');
                    showNotification('üîå Connection error', 'error');
                });
        }

        function showStatus(text, status) {
            const indicator = document.getElementById('statusIndicator');
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            indicator.style.display = 'block';
            statusText.textContent = text;
            dot.className = `status-dot status-${status}`;
        }

        function showActivationPopup(icon, modeName, action) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 0.8rem 1.5rem;
                border-radius: 50px;
                text-align: center;
                z-index: 3000;
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                animation: slideInDown 0.5s ease;
                font-size: 0.9rem;
                font-weight: 600;
                backdrop-filter: blur(10px);
            `;
            
            popup.innerHTML = `
                ${icon} ${modeName} ${action === 'activated' ? 'ACTIVATED' : 'STOPPED'}
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.style.animation = 'slideOutUp 0.5s ease';
                setTimeout(() => popup.remove(), 500);
            }, 2000);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#00ff00' : type === 'error' ? '#ff0000' : '#3a7bd5'};
                color: white;
                padding: 1rem 2rem;
                border-radius: 50px;
                font-weight: 600;
                z-index: 2000;
                animation: slideInDown 0.5s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutUp 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        let firstOpen = true;

        document.getElementById("chatbot-toggle").onclick = () => {
            const chatbox = document.getElementById("chatbox");
            chatbox.classList.toggle("hidden");

            if (!chatbox.classList.contains("hidden") && firstOpen) {
                const chatMessages = document.getElementById("chat-messages");
                chatMessages.innerHTML += `<div class='bot-msg'><b>Bot:</b> üëã Hi there!</div>`;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                firstOpen = false;
            }
        };

        document.getElementById("close-chat").onclick = () => {
            document.getElementById("chatbox").classList.add("hidden");
        };

        async function sendMessage() {
            const input = document.getElementById("chat-input");
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById("chat-messages");
            chatMessages.innerHTML += `<div class='user-msg'><b>You:</b> ${message}</div>`;

            input.value = "";

            const typingDiv = document.createElement("div");
            typingDiv.className = "bot-msg";
            typingDiv.id = "typing";
            typingDiv.innerHTML = "<i>Bot is typing...</i>";
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message })
            });

            const data = await res.json();
            typingDiv.remove();

            chatMessages.innerHTML += `<div class='bot-msg'><b>Bot:</b> ${formatMessage(data.response)}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;

    function formatMessage(text) {
        let formatted = text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
    
        formatted = formatted.replace(/\n/g, "<br>");
    
        return formatted;
    }
        }

        document.getElementById("send-btn").onclick = sendMessage;
        document.getElementById("chat-input").addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        const trackContainer = document.getElementById('modeTrack'); 
        const track = trackContainer.querySelector('.carousel-track'); 
        
        let currentIndex = 4; 
        let cardWidth = 432; 
        let totalRealCards = 0;
        let isScrolling = false;

        function setupInfiniteCarousel() {
            const cards = Array.from(track.children);
            if (cards.length === 0) return;

            totalRealCards = cards.length;

            const trackStyle = window.getComputedStyle(track);
            const gap = parseFloat(trackStyle.gap || trackStyle.columnGap) || 32; 
            cardWidth = cards[0].offsetWidth + gap; 
            console.log("Calculated CardWidth:", cardWidth);

            const clonesEnd = cards.map(c => c.cloneNode(true));
            const clonesStart = cards.map(c => c.cloneNode(true));

            clonesEnd.forEach(c => track.appendChild(c));
            clonesStart.reverse().forEach(c => track.insertBefore(c, track.firstChild));

            updateScrollPosition(true); 
            updateActiveCard();
        }

        function updateScrollPosition(instant = false) {
            trackContainer.scrollTo({
                left: currentIndex * cardWidth,
                behavior: instant ? 'auto' : 'smooth'
            });
        }

        function updateActiveCard() {
            const allCards = Array.from(track.children);
            allCards.forEach((card, index) => {
                if (index === currentIndex + 1) { 
                     card.classList.add('active-center');
                } else {
                     card.classList.remove('active-center');
                }
            });
        }

        function checkBoundary() {
            
            const realStart = 4;
            const realEnd = 4 + totalRealCards - 1;

            if (currentIndex < realStart) {
                currentIndex = realEnd - (realStart - 1 - currentIndex); 
                updateScrollPosition(true);
            } else if (currentIndex > realEnd) {
                currentIndex = realStart + (currentIndex - realEnd - 1); 
                updateScrollPosition(true);
            }
            
            updateActiveCard();
            isScrolling = false;
        }

        window.addEventListener('load', setupInfiniteCarousel);

        function scrollCarousel(direction) {
            if (isScrolling) return;
            isScrolling = true;

            currentIndex += direction;
            updateScrollPosition();
            updateActiveCard();

            setTimeout(checkBoundary, 600); 
        }
    </script>
</body>
</html>