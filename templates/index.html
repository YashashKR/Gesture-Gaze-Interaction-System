<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Multimodal Air Canvas</title>
</head>
<body>
    <a href="{{ url_for('index') }}">
    <img src="{{ url_for('static', filename='images/download.jpg') }}" 
         alt="AirCanvas Logo" 
         class="logo">
    </a>
    <div class="container">
        <h1>Multimodal Air Canvas</h1>
        <button onclick="window.location.href='/start/hand'">Start Gesture Mode</button>
        <button onclick="window.location.href='/start/eye'">Start Eye Tracking Mode</button>
        <button onclick="window.location.href='/start/canvas'">Start Canvas Mode</button>
        <button onclick="window.location.href='/stop'">Stop Detection</button>

    </div>

    <!-- Chatbot floating button -->
<div id="chatbot-container">
    <button id="chatbot-toggle">üí¨</button>
    <div id="chatbox" class="hidden">
        <div id="chatbox-header">
            <span>AirCanvas Assistant ü§ñ</span>
            <button id="close-chat">‚úñ</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask me something..." />
            <button id="mic-btn">üéôÔ∏è</button>
            <button id="send-btn">‚û§</button>

        </div>
    </div>
</div>

<script>
    // Toggle chatbot popup
    let firstOpen = true; // Track if it's the first time opening

// Toggle chatbot popup
document.getElementById("chatbot-toggle").onclick = () => {
    const chatbox = document.getElementById("chatbox");
    chatbox.classList.toggle("hidden");

    // Send greeting only the first time
    if (!chatbox.classList.contains("hidden") && firstOpen) {
        const chatMessages = document.getElementById("chat-messages");
        chatMessages.innerHTML += `<div class='bot-msg'><b>Bot:</b> üëã Hi there!</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        firstOpen = false; // Prevent repeating
    }
};


    // Close button
    document.getElementById("close-chat").onclick = () => {
        document.getElementById("chatbox").classList.add("hidden");
    };

    // Send message
    async function sendMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message) return;

        const chatMessages = document.getElementById("chat-messages");
        chatMessages.innerHTML += `<div class='user-msg'><b>You:</b> ${message}</div>`;
        


        // Clear input after sending
        input.value = "";

        // Typing indicator
        const typingDiv = document.createElement("div");
        typingDiv.className = "bot-msg";
        typingDiv.id = "typing";
        typingDiv.innerHTML = "<i>Bot is typing...</i>";
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Fetch response
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        const data = await res.json();
        typingDiv.remove();

        chatMessages.innerHTML += `<div class='bot-msg'><b>Bot:</b> ${data.response}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    document.getElementById("send-btn").onclick = sendMessage;
    document.getElementById("chat-input").addEventListener("keypress", e => {
        if (e.key === "Enter") sendMessage();
    });

    // üé§ Voice recognition setup
const micBtn = document.getElementById("mic-btn");
let recognizing = false;
let recognition;

if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onstart = () => {
        recognizing = true;
        micBtn.style.background = "#e74c3c"; // red while recording
    };

    recognition.onend = () => {
        recognizing = false;
        micBtn.style.background = "#024277"; // back to normal
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("chat-input").value = transcript;
        sendMessage(); // Automatically send after recognition
    };
}

micBtn.onclick = () => {
    if (!recognizing && recognition) {
        recognition.start();
    } else if (recognition) {
        recognition.stop();
    }
};



</script>

</body>
</html>
